<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Omv√§nd Artnyckel Naturv√•rdsarter</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

</head>
<body>
    <h1>Omv√§nd Artnyckel f√∂r Naturv√•rdsarter</h1>

    <div class="filterrad">
        <div>
            <label for="plats">Utbredningszon</label><br>
            <select id="plats">
                <option value="">Alla zoner</option>
            </select>
        </div>
        <div>
            <label for="habitat">Habitat</label><br>
            <select id="habitat">
                <option value="">Alla habitat</option>
            </select>
        </div>
        <div>
            <label for="substrat">Substrat art</label><br>
            <select id="substrat" multiple size="3">
                <option value="ALLA">Alla substrat</option>
            </select>
        </div>
        <div>
            <label for="organismgrupp">Organismgrupp</label><br>
            <select id="organismgrupp">
                <option value="">Alla grupper</option>
            </select>
        </div>
    </div>

    <label for="artnamn">Vilken art vill du unders√∂ka?</label><br>
    <div class="s√∂krad-autocomplete">
        <input type="text" id="artnamn" placeholder="Ex: kn√§rot" autocomplete="off" oninput="visaF√∂rslag()" onfocus="visaF√∂rslag()">
    </div>
    <div id="f√∂rslaglista"></div>
    <div id="resultat"></div>

    <h3>Arter som setts n√§ra andra arter:</h3>
    <div class="sambandsrad">
        <textarea id="arts√∂klista" placeholder="Skriv artnamn, en per rad" rows="5"></textarea>
        <button onclick="visaSambandsarter()">‚û§</button>
        <div id="viktslider-container">
            <label for="viktslider">Kantvikt:</label>
            <input type="range" id="viktslider" min="1" max="100" value="50" step="1" oninput="uppdateraViktGr√§ns(this.value)">
            <span id="viktv√§rde">50</span>
        </div>
    </div>
    <div id="sambandsresultat"></div>
    <!-- <div id="grafContainer" style="height: 400px; border: 1px solid #ccc; margin-top: 1rem;"></div> -->


    <div id="bild-popup" class="popup-overlay" onclick="st√§ngPopup()">
        <img id="popup-bild" class="popup-bild" src="" alt="">
    </div>

    <script>
        let artdata = [];
        let samobservationsGraf = {};
        let observationCounts = {};
        let aktuellViktGr√§ns = 50;

        Promise.all([
            fetch("naturv√•rdsarter.json").then(res => res.json()),
            fetch("artgraf_namn.json").then(res => res.json()),
            fetch("observation_counts.json").then(res => res.json())
        ]).then(([artDataRes, grafRes, countsRes]) => {
            artdata = artDataRes;
            samobservationsGraf = grafRes;
            observationCounts = countsRes;
            init();  
        }).catch(error => {
            console.error("Fel vid inl√§sning av JSON-filer:", error);
        });

        function init() {
            fyllFiltermenyer();
        }

        function uppdateraViktGr√§ns(nyttV√§rde) {
            aktuellViktGr√§ns = parseInt(nyttV√§rde);
            document.getElementById("viktv√§rde").textContent = nyttV√§rde;
            visaSambandsarter();  // Rita om grafen med ny gr√§ns
        }

        function fyllFiltermenyer() {
            const platsSelect = document.getElementById("plats");
            const substratSelect = document.getElementById("substrat");
            const habitatSelect = document.getElementById("habitat");
            const organismgruppSelect = document.getElementById("organismgrupp");

            const organismgrupper = new Set();
            const zoner = new Set();
            const habitattyper = new Set();
            const substrattyper = new Set();

            artdata.forEach(art => {
                // Utbredning
                if (Array.isArray(art.Utbredning)) {
                    art.Utbredning.forEach(zon => {
                        if (typeof zon === "string") {
                            zoner.add(zon.trim());
                        }
                    });
                }

                // Habitat
                const habitatF√§lt = art.habitat || art.Habitat;
                if (Array.isArray(habitatF√§lt)) {
                    habitatF√§lt.forEach(h => {
                        if (typeof h === "string") {
                            habitattyper.add(h.trim());
                        }
                    });
                } else if (typeof habitatF√§lt === "string") {
                    habitattyper.add(habitatF√§lt.trim());
                }

                // Substrat art
                const substratF√§lt = art["Substrat art"];
                if (Array.isArray(substratF√§lt)) {
                    substratF√§lt.forEach(sub => {
                        if (typeof sub === "string") {
                            substrattyper.add(sub.trim());
                        }
                    });
                } else if (typeof substratF√§lt === "string") {
                    substrattyper.add(substratF√§lt.trim());
                }

                // Organismgrupp
                if (typeof art.Organismgrupp === "string") {
                    organismgrupper.add(art.Organismgrupp.trim());
                }
            });

            // Fyll menyer
            Array.from(zoner).sort((a, b) => a.localeCompare(b, 'sv')).forEach(zon => {
                platsSelect.appendChild(new Option(zon, zon));
            });

            Array.from(habitattyper).sort((a, b) => a.localeCompare(b, 'sv')).forEach(hab => {
                habitatSelect.appendChild(new Option(hab, hab));
            });

            Array.from(substrattyper).sort((a, b) => a.localeCompare(b, 'sv')).forEach(sub => {
                substratSelect.appendChild(new Option(sub, sub));
            });

            Array.from(organismgrupper).sort((a, b) => a.localeCompare(b, 'sv')).forEach(grupp => {
                organismgruppSelect.appendChild(new Option(grupp, grupp));
            });
        }

        function visaArt() {
            const plats = document.getElementById("plats").value.trim();
            const namn = document.getElementById("artnamn").value.trim().toLowerCase();
            const valdHabitat = document.getElementById("habitat").value;
            const resultatDiv = document.getElementById("resultat");
            resultatDiv.innerHTML = "";

            if (!namn) {
                resultatDiv.innerText = "Ange ett artnamn.";
                return;
            }

            const art = artdata.find(a => a.Art?.toLowerCase() === namn);

            if (!art) {
                resultatDiv.innerText = "Arten hittades inte.";
                return;
            }

            const count = observationCounts[art.Art];

            // Generera bilder (max 2)
            let bilderHtml = "";
            for (let i = 1; i <= 2; i++) {
                const bildPath = `Bilder_webp/${encodeURIComponent(art.Art)}_${i}.webp`;
                bilderHtml += `<img src="${bildPath}" alt="${art.Art}" class="f√∂rv√§xlingsbild"
                    onclick="visaPopup('${bildPath}', '${art.Art}')" 
                    onerror="this.style.display='none'">`;
            }

            let html = `
                <div class="art-block">
                    <div class="art-flexbox">
                        <div class="art-f√§lten">
                            <h2>
                                ${art.Art} <em>${art.Latin || ""}</em> 
                                <span class="observation-info"># I omr√•det 2000‚Äì2024: ${count || "0"}</span>
                            </h2>

                            ${redigerbartF√§lt("S√§rdrag", "S√§rdrag", art)}
                            ${redigerbartF√§lt("Milj√∂", "milj√∂", art)}
                            ${redigerbartF√§lt("Substrat", "substrat", art)}
                            ${redigerbartF√§lt("Utbredning", "Utbredning", art)}
                            ${redigerbartF√§lt("Indikerar", "Indikerar", art)}
                            <div class="spara-knapp-container">
                                <button class="spara-knapp" onclick="sparaRedigeradJson()">üíæ</button>
                            </div>
                        </div>
                        <div class="art-bilder-vertikal">
                            ${bilderHtml}
                        </div>
                    </div>
                </div>
            `;


            if (Array.isArray(art.F√∂rv√§xling) && art.F√∂rv√§xling.length > 0) {
                html += "<h3>F√∂rv√§xlingsarter:</h3>";
                art.F√∂rv√§xling.forEach(namn => {
                    const namnSanerat = namn.trim().toLowerCase();
                    const f = artdata.find(a => a.Art?.trim().toLowerCase() === namnSanerat);
                    if (f) {
                        const bildPath = `Bilder_webp/${f.Art}_1.webp`;
                        html += `
                            <div class="f√∂rv√§xling">
                                <div class="f√∂rv√§xling-flex">
                                    <div class="f√∂rv√§xling-info">
                                        <h4>${f.Art} <em>${f.Latin || ""}</em></h4>
                                        <p><strong>S√§rdrag:</strong> ${f.S√§rdrag || "saknas"}</p>
                                        ${f.milj√∂ ? `<p><strong>Milj√∂:</strong> ${f.milj√∂}</p>` : ""}
                                        ${f.substrat ? `<p><strong>Substrat:</strong> ${f.substrat}</p>` : ""}
                                        ${f.Indikerar ? `<p><strong>Indikerar:</strong> ${f.Indikerar}</p>` : ""}
                                    </div>
                                    <div class="f√∂rv√§xling-bild">
                                        <img src="${bildPath}" alt="${f.Art}" class="f√∂rv√§xlingsbild"
                                            onclick="visaPopup('${bildPath}', '${f.Art}')" 
                                            onerror="this.style.display='none'">
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            }


            // Visa samobserverade arter
            const samobs = samobservationsGraf[art.Art];
            if (samobs && typeof samobs === "object") {
                const samobsArter = Object.entries(samobs)
                    .sort((a, b) => b[1].weight - a[1].weight)
                    .slice(0, 5); // max 5

                if (samobsArter.length > 0) {
                    html += `<h3>Samobserverade arter:</h3><ul>`;
                    samobsArter.forEach(([namn, info]) => {
                        html += `<li>${namn} <span style="color: #999;">(vikt: ${info.weight})</span></li>`;
                    });
                    html += `</ul>`;
                }
            }

            if (Array.isArray(art.F√∂rv√§xling) && art.F√∂rv√§xling.length > 0) {
                const f√∂rvArter = art.F√∂rv√§xling
                    .map(namn => artdata.find(a => a.Art?.trim().toLowerCase() === namn.trim().toLowerCase()))
                    .filter(Boolean);

                html += "<h3>J√§mf√∂relse med f√∂rv√§xlingsarter:</h3>";
                html += byggJ√§mf√∂relsetabell(art, f√∂rvArter);
            }

            resultatDiv.innerHTML = html;
        }

        function visaF√∂rslag() {    
            const input = document.getElementById("artnamn");
            const lista = document.getElementById("f√∂rslaglista");
            const query = input.value.trim().toLowerCase();
            const valdOrganismgrupp = document.getElementById("organismgrupp").value;
            const valdZon = document.getElementById("plats").value;
            let valdaSubstrat = Array.from(document.getElementById("substrat").selectedOptions)
                .map(option => option.value);
            const valdHabitat = document.getElementById("habitat").value;

            if (valdaSubstrat.includes("ALLA")) {
                valdaSubstrat = [];
            }

            lista.innerHTML = "";
            //if (query.length === 0) return;

            const matchande = artdata.filter(art => {
                // Matchar artnamn?
                const namnMatch = art.Art?.toLowerCase().startsWith(query);
                if (!namnMatch) return false;

                // Matchar utbredning?
                if (valdZon) {
                    if (!Array.isArray(art.Utbredning) || !art.Utbredning.includes(valdZon)) {
                        return false;
                    }
                }

                if (valdHabitat) {
                    const artHabitat = art.habitat || art.Habitat;
                    if (Array.isArray(artHabitat)) {
                        if (!artHabitat.includes(valdHabitat)) return false;
                    } else {
                        if (artHabitat !== valdHabitat) return false;
                    }
                }

                if (valdaSubstrat.length > 0) {
                    const substratArt = art["Substrat art"];
                    if (!Array.isArray(substratArt)) return false;

                    const harMatchandeSubstrat = valdaSubstrat.some(s => substratArt.includes(s));
                    if (!harMatchandeSubstrat) return false;
                }

                if (valdOrganismgrupp && art.Organismgrupp !== valdOrganismgrupp) return false;

                return true;
            });

            // Visa max 10 f√∂rslag
            matchande.slice(0, 10).forEach(art => {
                const item = document.createElement("div");
                item.className = "f√∂rslag-item";
                item.textContent = art.Art;
                item.onclick = () => {
                    input.value = art.Art;
                    lista.innerHTML = "";
                    visaArt(); 
                        
                    const textarea = document.getElementById("arts√∂klista");
                    if (textarea && textarea.value.trim() === "") {
                        textarea.value = art.Art; // F√∂rhandsifyll sambands-textarea
                    }
                };
                lista.appendChild(item);
            });
        }

        function visaSambandsarter() {
            const input = document.getElementById("arts√∂klista").value.trim();
            const artnamnLista = input
                .split(/\n|,/)
                .map(n => n.trim().toLowerCase())
                .filter(n => n.length > 0);
            const resultatDiv = document.getElementById("sambandsresultat");
            resultatDiv.innerHTML = "";
            

            if (artnamnLista.length === 0) {
                resultatDiv.innerText = "Ange minst en art.";
                return;
            }

            const grannlistor = artnamnLista.map(namn => {
                const grannar = samobservationsGraf[namn] || samobservationsGraf[namn.charAt(0).toUpperCase() + namn.slice(1)];
                if (!grannar) {
                    resultatDiv.innerText = `Arten "${namn}" finns inte i grafen.`;
                    throw new Error(`Saknas i grafen: ${namn}`);
                }
                return grannar;
            });

            const gemensammaGrannar = Object.keys(grannlistor[0]).filter(granne => {
                if (artnamnLista.includes(granne)) return false;
                return grannlistor.every(g => granne in g);
            });

            if (gemensammaGrannar.length === 0) {
                resultatDiv.innerText = "Inga arter √§r kopplade till alla inmatade arter.";
                return;
            }

            const resultat = gemensammaGrannar.map(granne => {
                const vikter = grannlistor.map(g => g[granne]?.weight ?? 0);
                const minVikt = Math.min(...vikter);
                return { namn: granne, vikt: minVikt };
            });

            resultat.sort((a, b) => b.vikt - a.vikt);

            // üîπ Skapa wrapper-div f√∂r lista + graf
            const wrapper = document.createElement("div");
            wrapper.className = "flexcontainer";

            // üîπ Lista
            let listaHtml = "<div class='sambandslista'><h4>Gemensamt samobserverade arter:</h4><ul>";
            resultat.forEach(entry => {
                listaHtml += `<li>${entry.namn} <span style="color:#999;">(min vikt: ${entry.vikt.toFixed(2)})</span></li>`;
            });
            listaHtml += "</ul></div>";
            wrapper.innerHTML = listaHtml;

            // üîπ Graf
            const grafDiv = document.createElement("div");
            grafDiv.id = "grafContainer";
            // grafDiv.style.width = "400px";
            // grafDiv.style.height = "500px";
            // grafDiv.style.border = "1px solid #ccc";
            // grafDiv.style.marginLeft = "1rem";
            wrapper.appendChild(grafDiv);

            // üîπ S√§tt wrapper i resultatDiv
            resultatDiv.innerHTML = "";
            resultatDiv.appendChild(wrapper);

            const vikter = resultat.map(r => r.vikt);
            const minVikt = Math.min(...vikter);
            const maxVikt = Math.max(...vikter);

            function skalaViktTillL√§ngd(vikt) {
                const maxL√§ngd = 10;
                const minL√§ngd = 1;
                const logVikt = Math.log(vikt + 1); // skyddar mot nollor
                const logMin = Math.log(minVikt + 1);
                const logMax = Math.log(maxVikt + 1);
                const skala = (logVikt - logMin) / (logMax - logMin);
                return  maxL√§ngd - skala * (maxL√§ngd - minL√§ngd); //300/vikt;
            }

            const nodLista = [];
            const kantLista = [];

            const gemensammaGrannarNamn = resultat.map(r => r.namn);
            const allaNoder = [...new Set([...artnamnLista, ...gemensammaGrannarNamn])];

       
            allaNoder.forEach(namn => {
                const namnKorrekt = hittaGrafNamn(namn);
                if (!namnKorrekt) return;

                nodLista.push({
                    id: namnKorrekt,
                    label: namnKorrekt,
                    color: artnamnLista.includes(namn) ? "#2e7d32" : "#6666cc",
                    shape: "dot",
                    size: artnamnLista.includes(namn) ? 20 : 14
                });
            });

            const minViktGr√§ns = aktuellViktGr√§ns; 

            for (let i = 0; i < allaNoder.length; i++) {
                for (let j = i + 1; j < allaNoder.length; j++) {
                    const a = allaNoder[i];
                    const b = allaNoder[j];
                    const vikt = samobservationsGraf[a]?.[b]?.weight || samobservationsGraf[b]?.[a]?.weight;

                    if (vikt && vikt >= minViktGr√§ns) {
                        kantLista.push({
                            from: a,
                            to: b,
                            value: vikt,
                            title: `vikt: ${vikt.toFixed(2)}`,
                            length: 1 //skalaViktTillL√§ngd(vikt)
                        });
                    }
                }
            }

            function hittaGrafNamn(namn) {
                return samobservationsGraf[namn]
                    ? namn
                    : samobservationsGraf[namn.charAt(0).toUpperCase() + namn.slice(1)]
                        ? namn.charAt(0).toUpperCase() + namn.slice(1)
                        : null;
            }

            // L√§gg till starka kopplingar fr√•n artnamnLista (gr√∂na noder) √§ven om de √§r under minViktGr√§ns
            artnamnLista.forEach(fr√•nOriginal => {
                const fr√•n = hittaGrafNamn(fr√•nOriginal);
                if (!fr√•n) return;

                gemensammaGrannarNamn.forEach(tillOriginal => {
                    const till = hittaGrafNamn(tillOriginal);
                    if (!till) return;

                    const vikt = samobservationsGraf[fr√•n]?.[till]?.weight ?? samobservationsGraf[till]?.[fr√•n]?.weight;
                    if (vikt) {
                        kantLista.push({
                            from: fr√•n,
                            to: till,
                            value: vikt,
                            title: `vikt: ${vikt.toFixed(2)}`,
                            length: skalaViktTillL√§ngd(vikt)
                        });
                    }
                });
            });

            const networkData = {
                nodes: new vis.DataSet(nodLista),
                edges: new vis.DataSet(kantLista)
            };

            const options = {
                nodes: {
                    shape: "dot",
                    size: 10,
                    font: { size: 14 }
                },
                edges: {
                    arrows: "to",
                    color: "#ccc",
                    smooth: true
                },
                    physics: {
                        enabled: true,
                        solver: "forceAtlas2Based",  // eller "barnesHut", "repulsion"
                        stabilization: {
                            enabled: true,
                            iterations: 10,     // üëà Prova 50‚Äì200
                            updateInterval: 10
                        }
                    }
            };

            new vis.Network(grafDiv, networkData, options);
        }


        function byggJ√§mf√∂relsetabell(huvudArt, f√∂rv√§xlingsArter) {
            const allaArter = [huvudArt, ...f√∂rv√§xlingsArter];
            const artNamnLista = allaArter.map(a => a.Art);
            
            // H√§mta alla f√§lt som f√∂rekommer i minst en art
            const f√§ltAttJ√§mf√∂ra = Array.from(
                new Set(
                    allaArter.flatMap(art => Object.keys(art))
                )
            ).filter(f => f !== "Art" && f !== "Latin");  // exkludera namn

            const skillnader = {};

            f√§ltAttJ√§mf√∂ra.forEach(f√§lt => {
                const v√§rden = allaArter.map(a => (a[f√§lt] || "").toString().trim());
                const allaUnika = new Set(v√§rden);
                if (allaUnika.size > 1) {
                    skillnader[f√§lt] = v√§rden;
                }
            });

            if (Object.keys(skillnader).length === 0) return "<p>Inga tydliga skillnader i valda f√§lt.</p>";

            let html = "<table class='j√§mf√∂relsetabell'><thead><tr><th>F√§lt</th>";
            artNamnLista.forEach(namn => {
                html += `<th>${namn}</th>`;
            });
            html += "</tr></thead><tbody>";

            for (const [f√§lt, v√§rden] of Object.entries(skillnader)) {
                html += `<tr><td><strong>${f√§lt}</strong></td>`;
                v√§rden.forEach(v => {
                    html += `<td>${v || "-"}</td>`;
                });
                html += "</tr>";
            }

            // L√§gg till en rad: antal observationer
            html += "<tr><td><strong>Observationer</strong></td>";
            allaArter.forEach(art => {
                const count = observationCounts[art.Art] || 0;
                html += `<td>${count}</td>`;
            });
            html += "</tr>";

            html += "</tbody></table>";
            return html;
        }

        function redigerbartF√§lt(label, f√§lt, art) {
            const v√§rde = art[f√§lt] || "";
            const id = `f√§lt-${f√§lt.replace(/\s+/g, "")}`;
            const flerRaderF√§lt = ["s√§rdrag", "k√§nnetecken"];
            const rader = flerRaderF√§lt.includes(f√§lt.toLowerCase()) ? 2 : 1;

            return `
                <label for="${id}"><strong>${label}:</strong></label><br>
                <textarea id="${id}" class="redigerbart-f√§lt" data-f√§lt="${f√§lt}" rows="${rader}" oninput="uppdateraF√§lt(this, '${art.Art}')">${v√§rde}</textarea>
            `;
        }


        function uppdateraF√§lt(textarea, artNamn) {
            const f√§lt = textarea.dataset.f√§lt;
            const nyText = textarea.value;

            const art = artdata.find(a => a.Art === artNamn);
            if (art) {
                art[f√§lt] = nyText;
            }
        }

        function sparaRedigeradJson() {
            // G√• igenom alla textarea-f√§lt med data-f√§lt
            document.querySelectorAll(".redigerbart-f√§lt").forEach(textarea => {
                const f√§lt = textarea.dataset.f√§lt;
                const artnamn = textarea.getAttribute("oninput").match(/uppdateraF√§lt\(this, '(.+?)'\)/)[1];
                const art = artdata.find(a => a.Art === artnamn);
                if (art) {
                    art[f√§lt] = textarea.value.trim();
                }
            });

            const blob = new Blob([JSON.stringify(artdata, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const l√§nk = document.createElement("a");
            l√§nk.href = url;
            l√§nk.download = "redigerad_artdata.json";
            l√§nk.click();
            URL.revokeObjectURL(url);
        }

        function visaPopup(bildSrc, altText) {
            const popup = document.getElementById("bild-popup");
            const popupBild = document.getElementById("popup-bild");
            popupBild.src = bildSrc;
            popupBild.alt = altText;
            popup.style.display = "flex";
        }

        function st√§ngPopup() {
            document.getElementById("bild-popup").style.display = "none";
        }

    </script>
</body>
</html>
